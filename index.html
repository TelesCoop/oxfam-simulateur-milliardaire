<!DOCTYPE html>
<html lang="en" style="height: 100%">

<head>
    <meta charset="utf-8">
    <title>Oxfam - Comparer votre salaire avec celui d'un PDG français</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="robots" content="noindex">
    <link rel="stylesheet" href="css/oxfam.css">

    <script src="js/tmpl.min.js"></script>
    <link rel="import" href="/screens/step_01.html">
</head>

<body class="app-container">
<img class="" src="https://upload.wikimedia.org/wikipedia/fr/f/f0/OxfamLogo2017.png" alt="logo-oxfam" class="logo"/>
<div class="header">
    <h1 id="app-title" class="">Comparer votre salaire avec celui d'un PDG d'une grande entreprise française</h1>
</div>
<div class="container">
    <!-- SCREEN 1 -->
    <div class='screen' id="screen-1"></div>
    <!-- SCREEN 2 -->
    <div class='screen' id="screen-2"></div>
    <!-- SCREEN 3 -->
    <div class='screen' id="screen-3"></div>
    <!-- SCREEN 4 : error -->
    <div class='screen' id="screen-4"></div>
</div>


<!-- TEMPLATE SCREEN 1 -->
<script type="text/x-tmpl" id="tmpl-screen-1" style="display: none;">
    <div class='screen-wrapper'>
      <div class="current-step">
        <div class="step">
          <div class='step-number'>1</div>
          <div class="step-description">Saisi ton salaire brut annuel </div>
        </div>
      </div>
      <div class="user-inputs">
        <div class='input-wrapper'>
          <label for="userSalary">
            Quel est le montant de ton salaire brut annuel ?
          </label>
          <div class="salary-wrapper">
            <input
              type="text"
              id="userSalary"
              placeholder="30 000"
              oninput="onSalaryInput()"
            />
            <span class="addon">€</span>
          </div>
        </div>
      </div>
    </div>
    <div class="actions">
      <button
        class='btn button-disabled'
        id='btn-confirm-01'
        onclick="goToScreen2()"
      >SUIVANT</button>
    </div>
</script>

<!-- TEMPLATE SCREEN 2 -->
<script type="text/x-tmpl" id="tmpl-screen-2" style="display: none;">
    <div class='screen-wrapper'>
      <div class="current-step">
        <div class="step">
          <div class="step-number">2</div>
          <div class="step-description">Compare-toi à PDG d'une grande entreprise française.</div>
        </div>
      </div>
      <div class="user-inputs">
         <div class='input-wrapper'>
          <label for="enterprise">
            Choisi une grande entreprise française
          </label>
          <select name="enterprise" id="enterprise" oninput="onChangeEnterprise()">
            <option value="">Sélectionnez le nom d'une grande entreprise </option>
            {% for (let i=0; i<o.enterprises.length; i++) { %}
            <option value="{%=i%}">{%=o.enterprises[i][0]%}</option>
            {% } %}
          </select>
        </div>
      </div>
    </div>
    <div class="actions">
      <button
        class="btn button-disabled"
        id="btn-confirm-02"
        onclick="goToScreen3()"
        disabled
      >
        Valider
      </button>
    </div>
</script>

<!-- TEMPLATE SCREEN 3 -->
<script type="text/x-tmpl" id="tmpl-screen-3" style="display: none;">
    <div class='screen-wrapper'>
      <div class="current-step">
        <div class="step">
          <div class="step-number">3</div>
          <div class="step-description">Partage ton résultat</div>
        </div>
      </div>
      <div>
        <p class="text">
        {%=mainMsg%}
        </p>
        <p>
        La répartition des richesses créées au sein des grandes entreprises françaises est depuis des années largement favorable aux
        actionnaires et aux PDG, au détriment des salarié·e·s.
        Pour un meilleur partage des richesses au sein des grandes entreprises, Oxfam France appelle à limiter les écarts de salaire de
        1 à 20 entre le plus haut salaire et le salaire médian.
        </p>

      </div>
      <div class="input-wrapper">
        <div>
          <div class="actions">
            <button
              class="btn"
              id="btn-confirm-03"
              onclick="onTweetButtonHandler('{%=enterpriseName%}')"
            >PARTAGER SUR TWITTER</button>
          </div>
        </div>
      </div>
    </div>
</script>

<!-- TEMPLATE SCREEN 5 : error -->
<script type="text/x-tmpl" id="tmpl-screen-4" style="display: none;">
    <div class="screen-wrapper">
      <div>
        <img
          class="error-image"
          src="/images/cow-white.png"
          alt="illustration erreur"
        />
      </div>
      <p class="error-message">Nous sommes désolés, une erreur est survenue, veuillez essayer ultérieurement !</p>
    </div>
    <div class="actions">
      <button class="btn" onclick="goToScreen1(5);">
        Recommencer
      </button>
    </div>
</script>

<script type="application/javascript">
  let ENTERPRISES = [
    ["L'Oréal", 300],
    ['Stellantis', 3000000],
    ['LVMH', 30000000],
    ['Carrefour', 30000000],
    ["Sanofi", 30000000],
    ['Teleperformance', 30000000],
    ['Société Générale', 30000000],
  ]
  let enterpriseName = ''
  let userSalary = null // in €
  let ratioSalaryDiff = 0
  let coeffSalaryDifferenceShow = 0
  let pdgSalary = null
  let numbers = "0123456789".split('')
  let nbJourDiff = null
  let errorMessage
  let mainMsg = ""


  const showElement = (divId) => {
    document.getElementById(divId).style.display = 'block'
  }
  const hideElement = (divId) => {
    document.getElementById(divId).style.display = 'none'
  }
  const screenOpacity = (screenId, opacity) => {
    document.getElementById('screen-' + screenId).style.opacity = opacity
  }
  const screenTransition = (prevScreenId, nextScreenId) => {
    screenOpacity(prevScreenId, 0)
    setTimeout( () => {
      hideElement('screen-' + prevScreenId)
      showElement('screen-' + nextScreenId)
      setTimeout(() => {
        screenOpacity(nextScreenId, 1)
      }, 200)
    }, 200)
  }

  function AddWorkingDays(datStartDate, lngNumberOfWorkingDays, blnIncSat, blnIncSun) {
    var intWorkingDays = 5;
    var intNonWorkingDays = 2;
    var intStartDay = datStartDate.getDay(); // 0=Sunday ... 6=Saturday
    var intOffset;
    var intModifier = 0;

    if (blnIncSat) { intWorkingDays++; intNonWorkingDays--; }
    if (blnIncSun) { intWorkingDays++; intNonWorkingDays--; }
    var newDate = new Date(datStartDate)
    if (lngNumberOfWorkingDays >= 0) {
      // Moving Forward
      if (!blnIncSat && blnIncSun) {
        intOffset = intStartDay;
      } else {
        intOffset = intStartDay - 1;
      }
      // Special start Saturday rule for 5 day week
      if (intStartDay == 6 && !blnIncSat && !blnIncSun) {
        intOffset -= 6;
        intModifier = 1;
      }
    } else {
      // Moving Backward
      if (blnIncSat && !blnIncSun) {
        intOffset = intStartDay - 6;
      } else {
        intOffset = intStartDay - 5;
      }
      // Special start Sunday rule for 5 day week
      if (intStartDay == 0 && !blnIncSat && !blnIncSun) {
        intOffset++;
        intModifier = 1;
      }
    }
    // ~~ is used to achieve integer division for both positive and negative numbers
    newDate.setTime(datStartDate.getTime() + (new Number((~~((lngNumberOfWorkingDays + intOffset) / intWorkingDays) * intNonWorkingDays) + lngNumberOfWorkingDays + intModifier)*86400000));
    return newDate;
  }
  const showScreen = (screenId) => {
    ["1", "2", "3", "4"].map((screenId) => { hideElement(`screen-${screenId}`)})
    showElement('screen-' + screenId)
  }

  function addSpaces(numberStr) {
    if (numberStr.length <= 3) {
      return numberStr
    }
    if (numberStr.length > 3) {
      return addSpaces(numberStr.substr(0, numberStr.length - 3)) + ' ' + numberStr.substr(numberStr.length - 3)
    }
  }

  const addDays = (days) => {
    var date = new Date(2023, 0, 1)
    date.setDate(date.getDate() + days)
    return date.toLocaleDateString("fr")
  }


  function roundImpact(value) {
    if (value == null) {
      return
    }
    if (value > 10) {
      return Math.round(value)
    }
    if (value > 1) {
      return value.toFixed(1)
    }
    if (value > 0.1) {
      return value.toFixed(2)
    }
    if (value > 0.01) {
      return value.toFixed(3)
    }
    if (value > 0.001) {
      return value.toFixed(4)
    }
    if (value > 0.0001) {
      return value.toFixed(5)
    }
    return value.toPrecision(2)
  }

  function computeValues() {

    if (userSalary && pdgSalary) {
      ratioSalaryDiff = pdgSalary / userSalary
      nbJourDiff = (userSalary / pdgSalary) * 365
      if (ratioSalaryDiff > 1) {
        mainMsg += `Le PDG de ${enterpriseName} gagne ${ratioSalaryDiff} fois votre rémunération par an.
          Après le ${addDays(nbJourDiff)} (soit ${nbJourDiff} jours) il a déjà gagné votre salaire annuel.`
      } else if (ratioSalaryDiff === 1) {
        mainMsg += `Le PDG de ${enterpriseName} à une rémunération égale à la vôtre.`
      } else if(ratioSalaryDiff < 1) {
        mainMsg += `Vous gagnez ${userSalary / pdgSalary} fois la rémunération du PDG de ${enterpriseName}.`
      }
      let startDate = new Date(2023, 0, 1)
      const ecartDate = startDate

    } else {
      ratioSalaryDiff = null
    }
    coeffSalaryDifferenceShow = roundImpact(ratioSalaryDiff) + "M"
  }


  function checkStepValidity(confirmBtnId, conditionToCheck) {
    let confirmBtn = document.getElementById(confirmBtnId)
    if (conditionToCheck) {
      confirmBtn.classList.remove('button-disabled')
      confirmBtn.disabled = false
      return true
    } else {
      confirmBtn.classList.add('button-disabled')
      confirmBtn.disabled = true
    }
    return false
  }

  function onSalaryInput() {
    let salary = document.getElementById('userSalary').value
    // only keep numbers
    salary = salary.split('').filter((letter) => numbers.indexOf(letter) != -1).join('')
    userSalary = parseInt(salary)

    // add spaces
    salary = addSpaces(salary)
    document.getElementById('userSalary').value = salary
    checkStepValidity("btn-confirm-01", userSalary)
  }

  const onChangeEnterprise = () => {
    let enterpriseId = parseInt(document.getElementById('enterprise').value || -1)
    if (enterpriseId == null || enterpriseId === -1) {
      enterpriseName = ''
      pdgSalary = null
    } else {
      let enterprise = ENTERPRISES[enterpriseId]
      enterpriseName = enterprise[0]
      pdgSalary = enterprise[1]
    }
    console.log(enterpriseName, pdgSalary)
    checkStepValidity("btn-confirm-02", userSalary && pdgSalary)
  }

  const onTweetButtonHandler = (name) => {
    let text = encodeURI("Je viens de comparer l’empreinte carbone de mon patrimoine financier à celle de " + name + ". J’ai calculé en Millions de bouses de vaches pour me faire une meilleure idée…")
    let hashtags = "OhLaVache"
    let url = "https://www.oxfamfrance.org/vaches-milliardaires-et-climat/"
    let link = "https://twitter.com/intent/tweet?text=" + text + "&hashtags=" + hashtags + "&url=" + url
    window.open(link, '_blank').focus()
  }


  const updateTemplate = (screenId) => {
    let data = {
      enterprises: ENTERPRISES,
    }
    document.getElementById('screen-' + screenId).innerHTML = tmpl(
        'tmpl-screen-' + screenId, data
    )
    return true
  }

  const goToScreen2 = () => {
    const isValid = checkStepValidity("btn-confirm-01", userSalary)
    if(isValid) {
      updateTemplate(2)
      screenTransition(1, 2)
    }
  }

  const goToScreen3 = () => {
    const isValid = checkStepValidity("btn-confirm-02", userSalary && pdgSalary)
    if(isValid) {
      computeValues()
      updateTemplate(3)
      screenTransition(2, 3)
    }

  }

  const init = () => {
    updateTemplate(1)
    showScreen(1)
    screenTransition(1, 1)
  }
  init()
</script>
</body>

</html>
