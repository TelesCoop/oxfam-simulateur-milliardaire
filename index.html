<!DOCTYPE html>
<html lang="en" style="height: 100%">

<head>
    <meta charset="utf-8">
    <title>Oxfam - Comparer votre salaire avec celui d'un PDG français</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="robots" content="noindex">
    <link rel="stylesheet" href="css/oxfam.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="js/tmpl.min.js"></script>
    <link rel="import" href="/screens/step_01.html">
</head>

<body class="app-container">

<div class="header">
    <img class="logo" src="images/oxfam_logo_text.png" alt="logo-oxfam" class="logo" srcset="images/oxfam_logo_text_2x.png 2x"/>
</div>
<h1>Comparer votre salaire avec celui d'un PDG d'une grande entreprise française</h1>
<div class="container">
    <!-- SCREEN 1 -->
    <div class='screen' id="screen-1"></div>
    <!-- SCREEN 2 -->
    <div class='screen' id="screen-2"></div>
    <!-- SCREEN 3 -->
    <div class='screen' id="screen-3"></div>
    <!-- SCREEN 4 : error -->
    <div class='screen' id="screen-4"></div>
</div>


<!-- TEMPLATE SCREEN 1 -->
<script type="text/x-tmpl" id="tmpl-screen-1" style="display: none;">
<div class='screen-wrapper'>
  <div class="current-step">
    <div class="step">
      <div class='step-number'>1</div>
      <div class="step-description">Saisi ton salaire brut annuel </div>
    </div>
  </div>
  <div class="user-inputs">
    <div class='input-wrapper'>
      <label for="userSalary">
        Quel est le montant de ton salaire brut annuel ?
      </label>
      <div class="salary-wrapper">
        <input
          type="text"
          id="userSalary"
          placeholder="30 000"
          oninput="onSalaryInput()"
        />
        <span class="addon">€</span>
      </div>
    </div>
    <div class='input-wrapper'>
      <label for="enterprise">
        Choisi une grande entreprise française
      </label>
      <select name="enterprise" id="enterprise" oninput="onChangeEnterprise()">
        <option value="">Sélectionnez le nom d'une grande entreprise </option>
        {% for (let i=0; i<o.enterprises.length; i++) { %}
        <option value="{%=i%}">{%=o.enterprises[i][0]%}</option>
        {% } %}
      </select>
    </div>
  </div>
</div>
<div class="actions">
  <button
    class='btn button-disabled'
    id='btn-confirm-01'
    onclick="goToScreen2()"
  >SUIVANT</button>
</div>
</script>

<!-- TEMPLATE SCREEN 2 -->
<script type="text/x-tmpl" id="tmpl-screen-2" style="display: none;">
<div class='screen-wrapper'>
    <div class="current-step">
        <div class="step">
            <div class="step-number">2</div>
            <div class="step-description">Vous souhaitez agir pour faire bouger les grandes entreprises ? Laissez-nous vos coordonnées ! </div>
        </div>
    </div>
    <div class="user-inputs">
        <div class='input-wrapper'>
            <label for="surname">Nom</label>
            <input
                type="text"
                id="surname"
                placeholder="Nom"
                oninput="onSurnameInput()"
            />
        </div>
        <div class='input-wrapper'>
            <label for="name">Prénom</label>
            <input
                type="text"
                id="name"
                placeholder="Prénom"
                oninput="onNameInput()"
            />
        </div>
        <div class='input-wrapper'>
            <label for="email">Adresse e-mail</label>
            <input
                type="email"
                id="email"
                placeholder="Email"
                oninput="onEmailInput()"
            />

        </div>
    </div>

</div>
<div class="actions-col">
        <button
            class="btn button-disabled"
            id="btn-confirm-02"
            onclick="goToScreen3()"
            disabled
        >
            Valider
        </button>
        <button
        class="btn button btn-grey"
            onclick="goToScreen3(true)"
        >
        J'accède directement à mon résultat
        </button>
    </div>

</script>

<!-- TEMPLATE SCREEN 3 -->
<script type="text/x-tmpl" id="tmpl-screen-3" style="display: none;">
    <div class='screen-wrapper'>

      <div>
        <p class="text">
        {%=mainMsg%}
        </p>
        <p>
        La répartition des richesses créées au sein des grandes entreprises françaises est depuis des années largement favorable aux
        actionnaires et aux PDG, au détriment des salarié·e·s.
        Pour un meilleur partage des richesses au sein des grandes entreprises, Oxfam France appelle à limiter les écarts de salaire de
        1 à 20 entre le plus haut salaire et le salaire médian.
        </p>
      </div>
      <div class="input-wrapper">
        <div>
          <div class="actions">
            <button
              class="btn"
              id="btn-confirm-03"
              onclick="onTweetButtonHandler()"
            >PARTAGER SUR TWITTER</button>
          </div>
        </div>
      </div>
    </div>
</script>

<!-- TEMPLATE SCREEN 5 : error -->
<script type="text/x-tmpl" id="tmpl-screen-4" style="display: none;">
    <div class="screen-wrapper">
      <div>
        <img
          class="error-image"
          src="/images/cow-white.png"
          alt="illustration erreur"
        />
      </div>
      <p class="error-message">Nous sommes désolés, une erreur est survenue, veuillez essayer ultérieurement !</p>
    </div>
    <div class="actions">
      <button class="btn" onclick="goToScreen1(5);">
        Recommencer
      </button>
    </div>
</script>

<script type="application/javascript">

  let ENTERPRISES = [
    ["L'Oréal", 10097780],
    ['Stellantis', 66650518],
    ['LVMH', 7929234],
    ['Carrefour', 8403822],
    ["Sanofi", 8965298],
    ['Teleperformance', 19599499],
    ["Salaire moyen d'un PDG du CAC40", 7860000],
  ]

  let numbers = "0123456789".split('')
  let mainMsg = ""

  let name = ""
  let surname = ""
  let email = ""
  let enterpriseName = ''

  let userSalary = null // in €
  let ratioSalaryDiff = 0
  let nbJourDiff = null
  let pdgSalary = null

  const DATE_FORMAT = 'DDD MMMM YYYY à HH:mm:ss';
  const SUNDAY = 0; // moment day index
  const SATURDAY = 6; // moment day index
  const WEEKENDS = [SATURDAY, SUNDAY];
  const START_HOUR = 8
  const START_DATE = new Date(2023, 0, 1)

  const showElement = (divId) => {
    document.getElementById(divId).style.display = 'block'
  }
  const hideElement = (divId) => {
    document.getElementById(divId).style.display = 'none'
  }
  const screenOpacity = (screenId, opacity) => {
    document.getElementById('screen-' + screenId).style.opacity = opacity
  }
  const screenTransition = (prevScreenId, nextScreenId) => {
    screenOpacity(prevScreenId, 0)
    setTimeout(() => {
      hideElement('screen-' + prevScreenId)
      showElement('screen-' + nextScreenId)
      setTimeout(() => {
        screenOpacity(nextScreenId, 1)
      }, 200)
    }, 200)
  }


  const showScreen = (screenId) => {
    ["1", "2", "3", "4"].map((screenId) => {
      hideElement(`screen-${screenId}`)
    })
    showElement('screen-' + screenId)
  }

  function addSpaces(numberStr) {
    if (numberStr.length <= 3) {
      return numberStr
    }
    if (numberStr.length > 3) {
      return addSpaces(numberStr.substr(0, numberStr.length - 3)) + ' ' + numberStr.substr(numberStr.length - 3)
    }
  }

  const addDays = (days) => {
    var date = new Date(2023, 0, 1)
    date.setDate(date.getDate() + days)
    return date.toLocaleDateString("fr")
  }


  function roundImpact(value) {
    if (value == null) {
      return
    }
    if (value > 10) {
      return Math.round(value)
    }
    if (value > 1) {
      return value.toFixed(1)
    }
    if (value > 0.1) {
      return value.toFixed(2)
    }
    if (value > 0.01) {
      return value.toFixed(3)
    }
    if (value > 0.001) {
      return value.toFixed(4)
    }
    if (value > 0.0001) {
      return value.toFixed(5)
    }
    return value.toPrecision(2)
  }

  function computeDays(numberOfDays) {
    let date = moment(START_DATE).locale("fr");
    const hasHours = numberOfDays.toString().split(".")
    let count = 0;

    while (count < numberOfDays) {
      date.add(1, 'day');
      if (WEEKENDS.includes(date.day())) {
        continue;
      }
      count++;
    }
    date = date.add(START_HOUR, 'hours')
    if (hasHours) date.add(hasHours[1] / 10 * 12, "hours")
    return date.format(DATE_FORMAT)
  }

  function computeValues() {
    if (userSalary && pdgSalary) {
      ratioSalaryDiff = pdgSalary / userSalary
      nbJourDiff = Math.round(((userSalary / pdgSalary) * 320) * 100) / 100
      if (ratioSalaryDiff > 1) {
        mainMsg += `Le PDG de ${enterpriseName} gagne ${Math.round(ratioSalaryDiff)} fois votre rémunération par an.
          Après le ${computeDays(nbJourDiff)} il a déjà gagné votre salaire annuel.`
      } else if (ratioSalaryDiff === 1) {
        mainMsg += `Le PDG de ${enterpriseName} à une rémunération égale à la vôtre.`
      } else if (ratioSalaryDiff < 1) {
        mainMsg += `Vous gagnez ${userSalary / pdgSalary} fois la rémunération du PDG de ${enterpriseName}.`
      }
    } else {
      ratioSalaryDiff = null
    }
  }

  function checkStepValidity(confirmBtnId, conditionToCheck) {
    let confirmBtn = document.getElementById(confirmBtnId)
    if (conditionToCheck) {
      confirmBtn.classList.remove('button-disabled')
      confirmBtn.disabled = false
      return true
    } else {
      confirmBtn.classList.add('button-disabled')
      confirmBtn.disabled = true
    }
    return false
  }

  function onSalaryInput() {
    let salary = document.getElementById('userSalary').value
    // only keep numbers
    salary = salary.split('').filter((letter) => numbers.indexOf(letter) != -1).join('')
    userSalary = parseInt(salary)

    // add spaces
    salary = addSpaces(salary)
    document.getElementById('userSalary').value = salary
    checkStepValidity("btn-confirm-01", userSalary && pdgSalary)
  }
  const onSurnameInput = () => {
    let surnameValue = document.getElementById('surname').value
    console.log(surnameValue)
    surname = surnameValue
    checkStepValidity("btn-confirm-02", surname && name && email)
  }
  const onNameInput = () => {
    let nameValue = document.getElementById('name').value
    console.log(nameValue)
    name = nameValue
    checkStepValidity("btn-confirm-02", surname && name && email)
  }
  const onEmailInput = () => {
    let emailValue = document.getElementById('email').value
    console.log(emailValue)
    email = emailValue
    checkStepValidity("btn-confirm-02", surname && name && email)
  }
  const onChangeEnterprise = () => {
    let enterpriseId = parseInt(document.getElementById('enterprise').value || -1)
    if (enterpriseId == null || enterpriseId === -1) {
      enterpriseName = ''
      pdgSalary = null
    } else {
      let enterprise = ENTERPRISES[enterpriseId]
      enterpriseName = enterprise[0]
      pdgSalary = enterprise[1]
    }
    console.log(enterpriseName, pdgSalary)
    checkStepValidity("btn-confirm-01", userSalary && pdgSalary)
  }

  const onTweetButtonHandler = () => {
    let text = encodeURI("Je viens de comparer mon salaire avec le PDG de " + enterpriseName)
    let hashtags = "#"
    let url = "https://www.oxfamfrance.org//"
    let link = "https://twitter.com/intent/tweet?text=" + text + "&hashtags=" + hashtags + "&url=" + url
    window.open(link, '_blank').focus()
  }


  const updateTemplate = (screenId) => {
    let data = {
      enterprises: ENTERPRISES,
    }
    document.getElementById('screen-' + screenId).innerHTML = tmpl(
        'tmpl-screen-' + screenId, data
    )
    return true
  }

  const goToScreen2 = () => {
    const isValid = checkStepValidity("btn-confirm-01", userSalary)
    if (isValid) {
      updateTemplate(2)
      screenTransition(1, 2)
    }
  }

  const goToScreen3 = (skipStep=false) => {
    let isValid = checkStepValidity("btn-confirm-02", name && surname && email)
    if (skipStep) isValid = true

    if (isValid) {
      computeValues()
      updateTemplate(3)
      screenTransition(2, 3)
    }
  }

  const init = () => {
    updateTemplate(1)
    showScreen(1)
    screenTransition(1, 1)
  }
  init()
</script>
</body>

</html>
